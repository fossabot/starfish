FROM node:16-alpine3.11 as base

WORKDIR /usr/app/frontend

COPY frontend/package.json .

FROM base AS npm_install
RUN npm install

FROM node:16-alpine3.11 as npm_build
WORKDIR /usr/app/frontend
RUN chown -R node:node node_modules
RUN chmod -R 755 node_modules
COPY --from=npm_install /usr/app/frontend/node_modules node_modules

COPY @types/ /usr/app/@types
COPY common/ /usr/app/common
COPY frontend /usr/app/frontend

RUN chown -R node:node /usr/app/frontend/.nuxt
RUN chmod -R 755 /usr/app/frontend/.nuxt
RUN npm run build

FROM node:16-alpine3.11 as release
WORKDIR /usr/app/frontend
ENV HOST 0.0.0.0
COPY --from=npm_build /usr/app/frontend .
COPY --from=npm_build /usr/app/@types /usr/app/@types
COPY --from=npm_build /usr/app/common /usr/app/common

CMD ["npm", "run", "start"]
